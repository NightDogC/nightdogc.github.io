<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>【个人探索】研究一下保存游戏的设计与实现细节（基础篇） - 极东夜狗之巢穴</title><meta name="Description" content="Unreal Engine, Unity3D, Game Design, Game Development"><meta property="og:title" content="【个人探索】研究一下保存游戏的设计与实现细节（基础篇）" />
<meta property="og:description" content="警告 这是一个非计算机背景虚幻入门人员的个人探索，仅记录个人学习时想法和思考过程用，可能会看到各种奇奇怪怪的错误和“这不理所应当知道的知识？”" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-09T21:26:40+08:00" />
<meta property="article:modified_time" content="2022-11-09T21:26:40+08:00" /><meta property="og:site_name" content="极东夜狗之巢穴" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【个人探索】研究一下保存游戏的设计与实现细节（基础篇）"/>
<meta name="twitter:description" content="警告 这是一个非计算机背景虚幻入门人员的个人探索，仅记录个人学习时想法和思考过程用，可能会看到各种奇奇怪怪的错误和“这不理所应当知道的知识？”"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" /><link rel="prev" href="/posts/%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0%E5%A4%A7%E9%92%8A-%E8%99%9A%E5%B9%BBcpp%E7%9A%84%E8%BF%9B%E9%98%B6%E4%B9%8B%E8%B7%AF/" /><link rel="next" href="/posts/%E6%9D%82%E8%B0%88%E7%B3%BB%E5%88%97%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E4%B9%88%E8%8F%9C/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript>
<link rel="stylesheet" href="/js/katex/katex.min.css" >
<script src="/js/katex/katex.min.js" > </script>
<script src="/js/katex/contrib/auto-render.min.js" ></script>
 
<script>
    document.addEventListener("DOMContentLoaded", function() {
        let hasContent = document.getElementsByClassName('toc')[0].getAttribute('class');
        if (hasContent == null) {
            return;
        }
        renderMathInElement(document.body);
    });
</script><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "【个人探索】研究一下保存游戏的设计与实现细节（基础篇）",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/posts\/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F\/"
        },"genre": "posts","keywords": "Unreal, 个人探索, 保存游戏, 开发设计, 序列化, 项目源码解读, 内含有生之年, 基础","wordcount":  7210 ,
        "url": "\/posts\/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F\/","datePublished": "2022-11-09T21:26:40+08:00","dateModified": "2022-11-09T21:26:40+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "NightDog"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="极东夜狗之巢穴">极东夜狗之巢穴</a>
        </div>
        <div class="menu">
            <div class="menu-inner">
	                	<div class="dropdown">
		                  	<a href="/posts/" class="menu-item menu-more dropbtn" title="" ><i class='fas fa-fw fa-archive'></i> 归档 
		                	</a>
		                	<div class="menu-more-content dropdown-content"><a href="/categories/" title="" ><i class='fas fa-fw fa-th'></i> 全部分类 </a><a href="/tags/" title="" ><i class='fas fa-fw fa-tag'></i> 所有标签 </a></div>
		                </div>
	                <a class="menu-item" href="/categories/unreal/"> Unreal学习笔记 
		                </a>
	                	<div class="dropdown">
		                  	<a href="/categories/game/" class="menu-item menu-more dropbtn" title="" > 其他游戏相关 
		                	</a>
		                	<div class="menu-more-content dropdown-content"><a href="/categories/gamedesign/" title="" > 游戏设计相关 </a><a href="/categories/gamedev" title="" > 游戏开发相关 </a><a href="/categories/gamereview/" title="" > 游戏评论 </a><a href="/categories/personalwork" title="" > 个人游戏作品 </a></div>
		                </div>
	                <a class="menu-item" href="/categories/dev/"> 其它开发相关 
		                </a>
	                	<div class="dropdown">
		                  	<a href="/categories/other/" class="menu-item menu-more dropbtn" title="" > 其它的其它 
		                	</a>
		                	<div class="menu-more-content dropdown-content"><a href="/categories/meme/" title="" > 弔图一堆 </a><a href="/categories/ramble" title="" > 杂谈一堆 </a></div>
		                </div>
	                <a class="menu-item" href="/quickpost/"> 查询精神状态 
		                </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="极东夜狗之巢穴">极东夜狗之巢穴</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div>
                <div class="dropdown">
                      <a href="/posts/" class="menu-item menu-more dropbtn" title="" ><i class='fas fa-fw fa-archive'></i> 归档 
                    </a>
                    <div class="menu-more-content dropdown-content"><a href="/categories/" title="" ><i class='fas fa-fw fa-th'></i> 全部分类 </a><a href="/tags/" title="" ><i class='fas fa-fw fa-tag'></i> 所有标签 </a></div>
                </div>
            <a class="menu-item" href="/categories/unreal/"> Unreal学习笔记 
                </a>
                <div class="dropdown">
                      <a href="/categories/game/" class="menu-item menu-more dropbtn" title="" > 其他游戏相关 
                    </a>
                    <div class="menu-more-content dropdown-content"><a href="/categories/gamedesign/" title="" > 游戏设计相关 </a><a href="/categories/gamedev" title="" > 游戏开发相关 </a><a href="/categories/gamereview/" title="" > 游戏评论 </a><a href="/categories/personalwork" title="" > 个人游戏作品 </a></div>
                </div>
            <a class="menu-item" href="/categories/dev/"> 其它开发相关 
                </a>
                <div class="dropdown">
                      <a href="/categories/other/" class="menu-item menu-more dropbtn" title="" > 其它的其它 
                    </a>
                    <div class="menu-more-content dropdown-content"><a href="/categories/meme/" title="" > 弔图一堆 </a><a href="/categories/ramble" title="" > 杂谈一堆 </a></div>
                </div>
            <a class="menu-item" href="/quickpost/"> 查询精神状态 
                </a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">【个人探索】研究一下保存游戏的设计与实现细节（基础篇）</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>NightDog</a></span>&nbsp;<span class="post-category">included in <a href="/categories/unreal/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Unreal</a></span>&nbsp;with tags:&nbsp;<i class="fas fa-tags fa-fw" aria-hidden="true"></i><a href="/tags/unreal/">Unreal</a>,&nbsp;<a href="/tags/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2/">个人探索</a>,&nbsp;<a href="/tags/%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/">保存游戏</a>,&nbsp;<a href="/tags/%E5%BC%80%E5%8F%91%E8%AE%BE%E8%AE%A1/">开发设计</a>,&nbsp;<a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/">序列化</a>,&nbsp;<a href="/tags/%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">项目源码解读</a>,&nbsp;<a href="/tags/%E5%86%85%E5%90%AB%E6%9C%89%E7%94%9F%E4%B9%8B%E5%B9%B4/">内含有生之年</a>,&nbsp;<a href="/tags/%E5%9F%BA%E7%A1%80/">基础</a></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-11-09">2022-11-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;7210 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;15 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#综述">综述</a>
      <ul>
        <li><a href="#保存actor的准备工作接口和数据类型">保存Actor的准备工作：接口和数据类型</a>
          <ul>
            <li><a href="#对于需要存储的actor将变量转换为二进制并保存">对于需要存储的Actor，将变量转换为二进制并保存</a></li>
          </ul>
        </li>
        <li><a href="#保存playerdata">保存PlayerData</a></li>
        <li><a href="#读取playerdata">读取PlayerData</a></li>
        <li><a href="#对需要加载的actor将二进制转为变量并加载">对需要加载的Actor，将二进制转为变量并加载</a></li>
        <li><a href="#设计总结">设计总结</a></li>
        <li><a href="#一些补充和提高篇的展望">一些补充和提高篇的展望</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition warning open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content">这是一个<strong>非计算机背景</strong>虚幻入门人员的个人探索，仅记录个人学习时想法和思考过程用，可能会看到各种奇奇怪怪的错误和“这不理所应当知道的知识？”，十分不建议参考。</div>
        </div>
    </div>
<h2 id="综述">综述</h2>
<p>保存游戏，可以说是一个游戏中最重要的功能之一。根据虚幻官方文档的说法，保存游戏在游戏开发的早期就应该被设计出来：</p>
<blockquote>
<p>Every game needs to come up with a carefully thought out save game management plan early in the game&rsquo;s development.</p>
</blockquote>
<p>这点在做自己个人作品的时候就吃了亏，把保存游戏放到了最后实现，存还是能存，不过也就是在一个一本道流程里保存一下当前关卡id而已，好在作品简单，整体影响不大。</p>
<p>这么一个重要的功能，虚幻已经帮我们实现好了一套使用序列化的保存游戏功能USaveGame，如果在网上搜索虚幻保存游戏，无外乎都是教你如何调用USaveGame的API，但问题来了（也可能是我搜索能力还不够），光是调用API还不够，如何去设计一个游戏的保存功能呢？</p>
<p>大部分教程显然做得不够好，甚至有为了演示API直接把API调用写在Character类里的，因为他要存Character的HP数据。这里实际上会有两个问题，一是这么做本事其实是没问题的，但考虑到OO，Character在一个游戏里大概率不是上帝，拥有“保存”这种“能力”不太合适，我们需要一个设计来支持较大项目的保存。而第二个问题，面对一些中型以上的游戏，我们希望能保存各种各样的东西：敌人打到一半时它的状态、解谜过程中关卡的进度、玩家做任务的进度、甚至整个世界的进度等等，而不是保存玩家本身的状态就行了。</p>
<p>关于第二个问题，虚幻其实也有招，一是所有的UObject都继承了Serialize()支持序列化，二是虚幻在反射系统中提供了一个SaveGame标识符，这使得可以在UObject序列化的时候，有选择地将标识了SaveGame的属性进行保存，详细操作教程看Helo老师这篇即可：
<a href="https://zhuanlan.zhihu.com/p/445800413" target="_blank" rel="noopener noreffer ">UE4/UE5中保存游戏的基础知识 —— Basics about SaveGame in UE4/UE5</a></p>
<p>那么回到第一个问题，有了这套东西，以我目前的水平来说的一个想法是，可不可以设计一个组件或者接口，组合或接入想要保存的重要Actor，然后通过一个子系统进行管理？</p>
<p>但是先别急，对目前的我来说，胡乱进行设计不可取。事实上，保存功能不只是游戏，下至notepad，上至操作系统，undo和redo功能可太常见了，因此是有一个专门为此的设计模式的：<a href="https://blog.csdn.net/leonardohaig/article/details/109585166" target="_blank" rel="noopener noreffer ">C++设计模式——备忘录模式(Memento Pattern)</a></p>
<p>那么，结合大钊老师InsideUE的说法，USaveGame基本就是这个Memento了，剩下的就难以界定了，GameInstance、GameModeBase、各种State类、或者做一个SaveGameSubsystem去做剩下的事好像也都还行，毕竟虚幻直接为我们提供了CreateSaveGameObject、SaveGameToSlot、LoadGameFromSlot等等API，但为了<strong>尽可能地</strong>符合单一职责原则，也为了封装保存的数据，我们肯定还是希望专门有一个东西能够来负责这件事，这样来说，或许Subsystem确实是个不错的选择。</p>
<p>对于第二个问题，对于具体实现来说，光空想设计也不够，对于实现细节的处理也是有必要进行一番研究的，所以到了该进行项目参考的时候了！在众多不错的项目中，Tomlooman老师的ActionRoguelike的思路一眼看上去和我刚才的想法类似，可以看看他的具体实现。</p>
<p>首先会通读一遍代码，把实现中的要注意的要点都分析一下，这部分会占较大篇幅，然后对其进行一下总结，分析一下设计。</p>
<p>项目链接在此：<a href="https://github.com/tomlooman/ActionRoguelike" target="_blank" rel="noopener noreffer ">Tomlooman老师的ActionRoguelike</a>，他还贴心的写了一篇教程：<a href="https://www.tomlooman.com/unreal-engine-cpp-save-system/" target="_blank" rel="noopener noreffer ">Unreal Engine C++ Save System (SaveGame)</a></p>
<h3 id="保存actor的准备工作接口和数据类型">保存Actor的准备工作：接口和数据类型</h3>
<p>在该项目中，对于想要保存的Actor接入了一个 <em>GameplayInterface</em> 接口，并在其中声明了<code>OnActorLoaded()</code></p>
<div class="details admonition note open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fas fa-angle-right fa-fw" aria-hidden="true"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>这个接口是Tomlooman老师复用的一个接口，里面的其余函数声明和保存无关。</p>
<p>在自己实践时，尽量提供纯粹为了保存使用的接口，并给予接口正确的命名。</p>
</div>
        </div>
    </div>
<p>在这里使用接口的一个好处是，既可以对需要保存的Actor进行标记，又可以通过 <code>OnActorLoaded()</code> 去实现一些加载后的逻辑。当然，这部分逻辑在BeginPlay()里写也是一样的，只要确保你能在Actor的BeginPlay()调用之前加载好数据。</p>
<p>然后是用于保存数据的Struct：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">USTRUCT</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FActorSaveData</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* Identifier for which Actor this belongs to */</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">FName</span> <span class="n">ActorName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* For movable Actors, keep location,rotation,scale. */</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">FTransform</span> <span class="n">Transform</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Contains all &#39;SaveGame&#39; marked variables of the Actor */</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">TArray</span><span class="o">&lt;</span><span class="n">uint8</span><span class="o">&gt;</span> <span class="n">ByteData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注释很明白，但有两个可以思考的地方。</p>
<ol>
<li>
<p>对于FTransform属性，为何要单独拎出来，这个会在后面体现出来</p>
</li>
<li>
<p>使用ActorName来标记，没有什么问题，只是后续看到TomLooman老师又点出也可以考虑使用FGuid来标记，对于runtime生成的Actor更有效，以及也可以有更多的解决方案</p>
</li>
</ol>
<h4 id="对于需要存储的actor将变量转换为二进制并保存">对于需要存储的Actor，将变量转换为二进制并保存</h4>
<p>其实这部分看刚才提到的这个也差不多：<a href="https://zhuanlan.zhihu.com/p/445800413" target="_blank" rel="noopener noreffer ">UE4/UE5中保存游戏的基础知识 —— Basics about SaveGame in UE4/UE5</a></p>
<p>但还是做一下笔记：</p>
<ul>
<li>使用 <code>FMemoryWriter</code> 和 <code>FObjectAndNameAsStringProxyArchive</code> （都继承自 <code>FArchive</code> ）能够将变量转换为二进制</li>
<li>然后就是源码了：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">USSaveGameSubsystem</span><span class="o">::</span><span class="n">WriteSaveGame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Clear arrays, may contain data from previously loaded SaveGame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">CurrentSaveGame</span><span class="o">-&gt;</span><span class="n">SavedPlayers</span><span class="p">.</span><span class="n">Empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">CurrentSaveGame</span><span class="o">-&gt;</span><span class="n">SavedActors</span><span class="p">.</span><span class="n">Empty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">AGameStateBase</span><span class="o">*</span> <span class="n">GS</span> <span class="o">=</span> <span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetGameState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">GS</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Warn about failure to save?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// Iterate all player states, we don&#39;t have proper ID to match yet (requires Steam or EOS)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">int32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GS</span><span class="o">-&gt;</span><span class="n">PlayerArray</span><span class="p">.</span><span class="n">Num</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ASPlayerState</span><span class="o">*</span> <span class="n">PS</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">ASPlayerState</span><span class="o">&gt;</span><span class="p">(</span><span class="n">GS</span><span class="o">-&gt;</span><span class="n">PlayerArray</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">PS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">PS</span><span class="o">-&gt;</span><span class="n">SavePlayerState</span><span class="p">(</span><span class="n">CurrentSaveGame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span> <span class="c1">// single player only at this point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Iterate the entire world of actors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">FActorIterator</span> <span class="n">It</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">());</span> <span class="n">It</span><span class="p">;</span> <span class="o">++</span><span class="n">It</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">AActor</span><span class="o">*</span> <span class="n">Actor</span> <span class="o">=</span> <span class="o">*</span><span class="n">It</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Only interested in our &#39;gameplay actors&#39;, skip actors that are being destroyed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Note: You might instead use a dedicated SavableObject interface for Actors you want to save instead of re-using GameplayInterface
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">Actor</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">Actor</span><span class="o">-&gt;</span><span class="n">Implements</span><span class="o">&lt;</span><span class="n">USGameplayInterface</span><span class="o">&gt;</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">FActorSaveData</span> <span class="n">ActorData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">ActorData</span><span class="p">.</span><span class="n">ActorName</span> <span class="o">=</span> <span class="n">Actor</span><span class="o">-&gt;</span><span class="n">GetFName</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">ActorData</span><span class="p">.</span><span class="n">Transform</span> <span class="o">=</span> <span class="n">Actor</span><span class="o">-&gt;</span><span class="n">GetActorTransform</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="c1">// Pass the array to fill with data from Actor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">FMemoryWriter</span> <span class="nf">MemWriter</span><span class="p">(</span><span class="n">ActorData</span><span class="p">.</span><span class="n">ByteData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">FObjectAndNameAsStringProxyArchive</span> <span class="nf">Ar</span><span class="p">(</span><span class="n">MemWriter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Find only variables with UPROPERTY(SaveGame)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Ar</span><span class="p">.</span><span class="n">ArIsSaveGame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Converts Actor&#39;s SaveGame UPROPERTIES into binary array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Actor</span><span class="o">-&gt;</span><span class="n">Serialize</span><span class="p">(</span><span class="n">Ar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Here CurrentSaveGame is a member variable of type USSaveGame*
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">CurrentSaveGame</span><span class="o">-&gt;</span><span class="n">SavedActors</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ActorData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">SaveGameToSlot</span><span class="p">(</span><span class="n">CurrentSaveGame</span><span class="p">,</span> <span class="n">CurrentSlotName</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">OnSaveGameWritten</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">CurrentSaveGame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>具体实现方法和UGameplayStatics内提供的保存相关API的做法差不多，但是注意到仍然在最后一步调用了Unreal的API，观察Unreal源码可知，SaveGameToSlot还会执行一遍序列化，然后执行存储到Slot、写入磁盘的逻辑，在这里是为了照顾还没有序列化的PlayerState的各种PROPERTY以及ActorName、FTransform这两个PROPERTY。</p>
<p>如果你打算不执行两次序列化，而是直接手动把要存的东西全都序列化先，那么可以考虑直接复制或修改Unreal的这些源码并针对自己的定制化需求做出改动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">SaveDataToSlot</span><span class="p">(</span><span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">uint8</span><span class="o">&gt;&amp;</span> <span class="n">InSaveData</span><span class="p">,</span> <span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">SlotName</span><span class="p">,</span> <span class="k">const</span> <span class="n">int32</span> <span class="n">UserIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ISaveGameSystem</span><span class="o">*</span> <span class="n">SaveSystem</span> <span class="o">=</span> <span class="n">IPlatformFeaturesModule</span><span class="o">::</span><span class="n">Get</span><span class="p">().</span><span class="n">GetSaveGameSystem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">SaveSystem</span> <span class="o">&amp;&amp;</span> <span class="n">InSaveData</span><span class="p">.</span><span class="n">Num</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">SlotName</span><span class="p">.</span><span class="n">Len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Stuff that data into the save system with the desired file name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="n">SaveSystem</span><span class="o">-&gt;</span><span class="n">SaveGame</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="o">*</span><span class="n">SlotName</span><span class="p">,</span> <span class="n">UserIndex</span><span class="p">,</span> <span class="n">InSaveData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">SaveGame</span><span class="p">(</span><span class="kt">bool</span> <span class="n">bAttemptToUseUI</span><span class="p">,</span> <span class="k">const</span> <span class="n">TCHAR</span><span class="o">*</span> <span class="n">Name</span><span class="p">,</span> <span class="k">const</span> <span class="n">int32</span> <span class="n">UserIndex</span><span class="p">,</span> <span class="k">const</span> <span class="n">TArray</span><span class="o">&lt;</span><span class="n">uint8</span><span class="o">&gt;&amp;</span> <span class="n">Data</span><span class="p">)</span> <span class="k">override</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">FFileHelper</span><span class="o">::</span><span class="n">SaveArrayToFile</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="o">*</span><span class="n">GetSaveGamePath</span><span class="p">(</span><span class="n">Name</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，这意味着失去了利用ActorName或者FGuid作为标记的功能，所以在加载的时候，如何确定反序列化时所对应的那个Actor？如何处理一些在Actor加载时的逻辑（比如SetTransform）？可能剖析完引擎源码这个问题就能轻松回答了，目前我的水平而言，只能改改代码试一试看看一些想法处理行不行得通了，考虑加入有生之年系列</p>
<p>甚至如果你不需要Slot，自行做一些判断后手动通过<code>FFileHelper::SaveArrayToFile(Data, *SavePath)</code> 保存到文件，通过 <code>FFileHelper::LoadFileToArray(Data, *SavePath)</code> 从文件加载即可</p>
<p>对了，不用特意去记住序列化的写法，明白FobjectAndNameAsStringProxyArchive和两个继承自FArchive的类，对于使用序列化来说基本够用了，因为Unreal帮你注释好了都：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Implements a proxy archive that serializes UObjects and FNames as string data.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Expected use is:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    FArchive* SomeAr = CreateAnAr();
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    FObjectAndNameAsStringProxyArchive Ar(*SomeAr);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    SomeObject-&gt;Serialize(Ar);
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    FinalizeAr(SomeAr);
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @param InInnerArchive The actual FArchive object to serialize normal data types (FStrings, INTs, etc)
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FObjectAndNameAsStringProxyArchive</span> <span class="o">:</span> <span class="k">public</span> <span class="n">FNameAsStringProxyArchive</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>序列化模块源码暂且不做进一步阅读了，等我的水平达到了需要进行引擎底层源码阅读的时候再具体剖析吧（加入有生之年套餐）</p>
<p>然后，以压缩形式保存文件的写法也一并转载过来，具体引擎源码也暂且不阅读了：</p>
<blockquote>
<p>以压缩形式保存到文件</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="n">TArray</span><span class="o">&lt;</span><span class="n">uint8</span><span class="o">&gt;</span> <span class="n">CompressedData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">FArchiveSaveCompressedProxy</span> <span class="nf">Compressor</span><span class="p">(</span><span class="n">CompressedData</span><span class="p">,</span> <span class="n">ECompressionFlags</span><span class="o">::</span><span class="n">COMPRESS_ZLIB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 压缩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Compressor</span> <span class="o">&lt;&lt;</span> <span class="n">Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 将archive序列化数据发送到二进制数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Compressor</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">FFileHelper</span><span class="o">::</span><span class="n">SaveArrayToFile</span><span class="p">(</span><span class="n">CompressedData</span><span class="p">,</span> <span class="o">*</span><span class="n">SavePath</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>从文件加载并解压</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="n">TArray</span><span class="o">&lt;</span><span class="n">uint8</span><span class="o">&gt;</span> <span class="n">CompressedData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FFileHelper</span><span class="o">::</span><span class="n">LoadFileToArray</span><span class="p">(</span><span class="n">CompressedData</span><span class="p">,</span> <span class="o">*</span><span class="n">SavePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 解压文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FArchiveLoadCompressedProxy</span> <span class="n">Decompressor</span><span class="p">(</span><span class="n">CompressedData</span><span class="p">,</span> <span class="n">ECompressionFlags</span><span class="o">::</span><span class="n">COMPRESS_ZLIB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 解压
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Decompressor</span> <span class="o">&lt;&lt;</span> <span class="n">Data</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="保存playerdata">保存PlayerData</h3>
<p>之前说过，对于PlayerState单独拎出来实现是有一定道理的，保存PlayerData的部分和正常使用USaveGame基本没有什么区别</p>
<p>但是还是有一些细节，拿出源码来看看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ASPlayerState</span><span class="o">::</span><span class="n">SavePlayerState_Implementation</span><span class="p">(</span><span class="n">USSaveGame</span><span class="o">*</span> <span class="n">SaveObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">SaveObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Gather all relevant data for player
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">FPlayerSaveData</span> <span class="n">SaveData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">SaveData</span><span class="p">.</span><span class="n">Credits</span> <span class="o">=</span> <span class="n">Credits</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">SaveData</span><span class="p">.</span><span class="n">PersonalRecordTime</span> <span class="o">=</span> <span class="n">PersonalRecordTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Stored as FString for simplicity (original Steam ID is uint64)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">SaveData</span><span class="p">.</span><span class="n">PlayerID</span> <span class="o">=</span> <span class="n">GetUniqueId</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// May not be alive while we save
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">APawn</span><span class="o">*</span> <span class="n">MyPawn</span> <span class="o">=</span> <span class="n">GetPawn</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">SaveData</span><span class="p">.</span><span class="n">Location</span> <span class="o">=</span> <span class="n">MyPawn</span><span class="o">-&gt;</span><span class="n">GetActorLocation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">SaveData</span><span class="p">.</span><span class="n">Rotation</span> <span class="o">=</span> <span class="n">MyPawn</span><span class="o">-&gt;</span><span class="n">GetActorRotation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">SaveData</span><span class="p">.</span><span class="n">bResumeAtTransform</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">SaveObject</span><span class="o">-&gt;</span><span class="n">SavedPlayers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">SaveData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先当然地，保存的方法写在了PlayerState里（加载也是）</p>
<p>其次，注意PlayerID和玩家死亡的情况的处理</p>
<p>然后关于这个函数名的_Implementation后缀（以及函数有标识符 <code>BlueprintNativeEvent</code> ），我猜可能是老师上课要在蓝图里演示？我也没开始看课，感觉理论上是不需要的</p>
<h3 id="读取playerdata">读取PlayerData</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ASPlayerState</span><span class="o">::</span><span class="n">LoadPlayerState_Implementation</span><span class="p">(</span><span class="n">USSaveGame</span><span class="o">*</span> <span class="n">SaveObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">SaveObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FPlayerSaveData</span><span class="o">*</span> <span class="n">FoundData</span> <span class="o">=</span> <span class="n">SaveObject</span><span class="o">-&gt;</span><span class="n">GetPlayerData</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">FoundData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//Credits = SaveObject-&gt;Credits;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// Makes sure we trigger credits changed event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">AddCredits</span><span class="p">(</span><span class="n">FoundData</span><span class="o">-&gt;</span><span class="n">Credits</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">PersonalRecordTime</span> <span class="o">=</span> <span class="n">FoundData</span><span class="o">-&gt;</span><span class="n">PersonalRecordTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogTemp</span><span class="p">,</span> <span class="n">Warning</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Could not find SaveGame data for player id &#39;%i&#39;.&#34;</span><span class="p">),</span> <span class="n">GetPlayerId</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那么，LoadPlayerState是怎么调用的呢，以及，好像没有看到设置位置信息的逻辑？</p>
<p>首先，调用加载的逻辑理论上写在很多地方都可以，比如加载关卡时，PS初始化时，等等，但其实这里有一个小细节，先看源码：</p>
<p>我们找到了在这里有一个调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">USSaveGameSubsystem</span><span class="o">::</span><span class="n">HandleStartingNewPlayer</span><span class="p">(</span><span class="n">AController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ASPlayerState</span><span class="o">*</span> <span class="n">PS</span> <span class="o">=</span> <span class="n">NewPlayer</span><span class="o">-&gt;</span><span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">ASPlayerState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ensure</span><span class="p">(</span><span class="n">PS</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">PS</span><span class="o">-&gt;</span><span class="n">LoadPlayerState</span><span class="p">(</span><span class="n">CurrentSaveGame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这显然不是终点，我们继续翻：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ASGameModeBase</span><span class="o">::</span><span class="n">HandleStartingNewPlayer_Implementation</span><span class="p">(</span><span class="n">APlayerController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Calling Before Super:: so we set variables before &#39;beginplayingstate&#39; is called in PlayerController (which is where we instantiate UI)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">USSaveGameSubsystem</span><span class="o">*</span> <span class="n">SG</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSubsystem</span><span class="o">&lt;</span><span class="n">USSaveGameSubsystem</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">SG</span><span class="o">-&gt;</span><span class="n">HandleStartingNewPlayer</span><span class="p">(</span><span class="n">NewPlayer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">HandleStartingNewPlayer_Implementation</span><span class="p">(</span><span class="n">NewPlayer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Now we&#39;re ready to override spawn location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Alternatively we could override core spawn location to use store locations immediately (skipping the whole &#39;find player start&#39; logic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SG</span><span class="o">-&gt;</span><span class="n">OverrideSpawnTransform</span><span class="p">(</span><span class="n">NewPlayer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>到了这里，发现是对GameMode里生成Player的逻辑部分进行了重载，并且拆分成了两部分（注意调用Subsystem的逻辑放在了 <code>Super::HandleStartingNewPlayer_Implementation()</code> 之前）</p>
<p>具体这么做的原因观察注释可知，由于在BeginPlayingState（PlayerController类中的方法）有初始化UI的逻辑，且会在 <code>Super::HandleStartingNewPlayer_Implementation()</code> 中使用，所以写在这之前便可以在UI加载之前就获取到变量信息，也就可以确保UI显示正确的信息了</p>
<p>这也是C++的优势所在，如果在蓝图中想做同样的处理可能会很复杂（但是也有简单的方法，比如直接DelayNextTick一下，但是不保证不出其他问题）</p>
<p>写到这突然想写一篇GI、Level、World、GM、GS、PC、PS、Pawn在初始化各种加载和函数调用顺序分析，已加入有生之年豪华套餐系列</p>
<p>还是回过来看加载PlayerState吧，在PlayerState全部加载完毕后，也就可以开始调用Subsystem里写好的设置位置信息的逻辑了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">USSaveGameSubsystem</span><span class="o">::</span><span class="n">OverrideSpawnTransform</span><span class="p">(</span><span class="n">AController</span><span class="o">*</span> <span class="n">NewPlayer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsValid</span><span class="p">(</span><span class="n">NewPlayer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">APlayerState</span><span class="o">*</span> <span class="n">PS</span> <span class="o">=</span> <span class="n">NewPlayer</span><span class="o">-&gt;</span><span class="n">GetPlayerState</span><span class="o">&lt;</span><span class="n">APlayerState</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">PS</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">APawn</span><span class="o">*</span> <span class="n">MyPawn</span> <span class="o">=</span> <span class="n">PS</span><span class="o">-&gt;</span><span class="n">GetPawn</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">FPlayerSaveData</span><span class="o">*</span> <span class="n">FoundData</span> <span class="o">=</span> <span class="n">CurrentSaveGame</span><span class="o">-&gt;</span><span class="n">GetPlayerData</span><span class="p">(</span><span class="n">PS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">FoundData</span> <span class="o">&amp;&amp;</span> <span class="n">FoundData</span><span class="o">-&gt;</span><span class="n">bResumeAtTransform</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>		
</span></span><span class="line"><span class="cl">			<span class="n">MyPawn</span><span class="o">-&gt;</span><span class="n">SetActorLocation</span><span class="p">(</span><span class="n">FoundData</span><span class="o">-&gt;</span><span class="n">Location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">MyPawn</span><span class="o">-&gt;</span><span class="n">SetActorRotation</span><span class="p">(</span><span class="n">FoundData</span><span class="o">-&gt;</span><span class="n">Rotation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// PlayerState owner is a (Player)Controller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">AController</span><span class="o">*</span> <span class="n">PC</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">AController</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PS</span><span class="o">-&gt;</span><span class="n">GetOwner</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Set control rotation to change camera direction, setting Pawn rotation is not enough
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">PC</span><span class="o">-&gt;</span><span class="n">SetControlRotation</span><span class="p">(</span><span class="n">FoundData</span><span class="o">-&gt;</span><span class="n">Rotation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意点是这是一个重载的逻辑，也就是说不要忘了PlayerController里面的 <code>SetControlRotation()</code></p>
<p>最后还有一点，已经两次看到 <code>GetPlayerData(APlayerState*)</code> 方法而没有细说了，其实很自然地能想到我们还有一个东西没有处理——PlayerID，那想必处理这部分的逻辑就是在这了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">FPlayerSaveData</span><span class="o">*</span> <span class="n">USSaveGame</span><span class="o">::</span><span class="n">GetPlayerData</span><span class="p">(</span><span class="n">APlayerState</span><span class="o">*</span> <span class="n">PlayerState</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">PlayerState</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Will not give unique ID while PIE so we skip that step while testing in editor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// UObjects don&#39;t have access to UWorld, so we grab it via PlayerState instead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">PlayerState</span><span class="o">-&gt;</span><span class="n">GetWorld</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">IsPlayInEditor</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogTemp</span><span class="p">,</span> <span class="n">Log</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;During PIE we cannot use PlayerID to retrieve Saved Player data. Using first entry in array if available.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">SavedPlayers</span><span class="p">.</span><span class="n">IsValidIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">&amp;</span><span class="n">SavedPlayers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// No saved player data available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Easiest way to deal with the different IDs is as FString (original Steam id is uint64)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Keep in mind that GetUniqueId() returns the online id, where GetUniqueID() is a function from UObject (very confusing...)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FString</span> <span class="n">PlayerID</span> <span class="o">=</span> <span class="n">PlayerState</span><span class="o">-&gt;</span><span class="n">GetUniqueId</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Iterate the array and match by PlayerID (eg. unique ID provided by Steam)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="n">SavedPlayers</span><span class="p">.</span><span class="n">FindByPredicate</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">const</span> <span class="n">FPlayerSaveData</span><span class="o">&amp;</span> <span class="n">Data</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Data</span><span class="p">.</span><span class="n">PlayerID</span> <span class="o">==</span> <span class="n">PlayerID</span><span class="p">;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>基本上要注意的点都在注释里写着了，没什么要说的了</p>
<h3 id="对需要加载的actor将二进制转为变量并加载">对需要加载的Actor，将二进制转为变量并加载</h3>
<p>这次使用 <code>FMemoryReader</code> 便可以在调用Serialize()时将二进制读取为变量了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">USSaveGameSubsystem</span><span class="o">::</span><span class="n">LoadSaveGame</span><span class="p">(</span><span class="n">FString</span> <span class="n">InSlotName</span> <span class="cm">/*= &#34;&#34;*/</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Update slot name first if specified, otherwise keeps default name
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SetSlotName</span><span class="p">(</span><span class="n">InSlotName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">DoesSaveGameExist</span><span class="p">(</span><span class="n">CurrentSlotName</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">CurrentSaveGame</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">USSaveGame</span><span class="o">&gt;</span><span class="p">(</span><span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">LoadGameFromSlot</span><span class="p">(</span><span class="n">CurrentSlotName</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">CurrentSaveGame</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogTemp</span><span class="p">,</span> <span class="n">Warning</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Failed to load SaveGame Data.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogTemp</span><span class="p">,</span> <span class="n">Log</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Loaded SaveGame Data.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Iterate the entire world of actors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="p">(</span><span class="n">FActorIterator</span> <span class="n">It</span><span class="p">(</span><span class="n">GetWorld</span><span class="p">());</span> <span class="n">It</span><span class="p">;</span> <span class="o">++</span><span class="n">It</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">AActor</span><span class="o">*</span> <span class="n">Actor</span> <span class="o">=</span> <span class="o">*</span><span class="n">It</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Only interested in our &#39;gameplay actors&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Actor</span><span class="o">-&gt;</span><span class="n">Implements</span><span class="o">&lt;</span><span class="n">USGameplayInterface</span><span class="o">&gt;</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="n">FActorSaveData</span> <span class="nl">ActorData</span> <span class="p">:</span> <span class="n">CurrentSaveGame</span><span class="o">-&gt;</span><span class="n">SavedActors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">ActorData</span><span class="p">.</span><span class="n">ActorName</span> <span class="o">==</span> <span class="n">Actor</span><span class="o">-&gt;</span><span class="n">GetFName</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">Actor</span><span class="o">-&gt;</span><span class="n">SetActorTransform</span><span class="p">(</span><span class="n">ActorData</span><span class="p">.</span><span class="n">Transform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="n">FMemoryReader</span> <span class="nf">MemReader</span><span class="p">(</span><span class="n">ActorData</span><span class="p">.</span><span class="n">ByteData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="n">FObjectAndNameAsStringProxyArchive</span> <span class="nf">Ar</span><span class="p">(</span><span class="n">MemReader</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">Ar</span><span class="p">.</span><span class="n">ArIsSaveGame</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// Convert binary array back into actor&#39;s variables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">Actor</span><span class="o">-&gt;</span><span class="n">Serialize</span><span class="p">(</span><span class="n">Ar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="n">ISGameplayInterface</span><span class="o">::</span><span class="n">Execute_OnActorLoaded</span><span class="p">(</span><span class="n">Actor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">OnSaveGameLoaded</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">(</span><span class="n">CurrentSaveGame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">CurrentSaveGame</span> <span class="o">=</span> <span class="n">Cast</span><span class="o">&lt;</span><span class="n">USSaveGame</span><span class="o">&gt;</span><span class="p">(</span><span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">CreateSaveGameObject</span><span class="p">(</span><span class="n">USSaveGame</span><span class="o">::</span><span class="n">StaticClass</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">UE_LOG</span><span class="p">(</span><span class="n">LogTemp</span><span class="p">,</span> <span class="n">Log</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">&#34;Created New SaveGame Data.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>循环那一波反序列化如果算一次反序列化的话，注意到这里其实有两次反序列化</p>
<p>至于调用，可以在主关卡加载时调用，总之确保在Actor的BeginPlay()之前就反序列化好就行，遇到额外的关卡流的情况可能会复杂一些，由于项目中没有这种需求，所以直接在GameModeBase的 <code>InitGame</code> 的重载里调用了，这个函数在加载过程中的很早期就会被调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ASGameModeBase</span><span class="o">::</span><span class="n">InitGame</span><span class="p">(</span><span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">MapName</span><span class="p">,</span> <span class="k">const</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">Options</span><span class="p">,</span> <span class="n">FString</span><span class="o">&amp;</span> <span class="n">ErrorMessage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Super</span><span class="o">::</span><span class="n">InitGame</span><span class="p">(</span><span class="n">MapName</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span> <span class="n">ErrorMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// (Save/Load logic moved into new SaveGameSubsystem)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">USSaveGameSubsystem</span><span class="o">*</span> <span class="n">SG</span> <span class="o">=</span> <span class="n">GetGameInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSubsystem</span><span class="o">&lt;</span><span class="n">USSaveGameSubsystem</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Optional slot name (Falls back to slot specified in SaveGameSettings class/INI otherwise)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">FString</span> <span class="n">SelectedSaveSlot</span> <span class="o">=</span> <span class="n">UGameplayStatics</span><span class="o">::</span><span class="n">ParseOption</span><span class="p">(</span><span class="n">Options</span><span class="p">,</span> <span class="s">&#34;SaveGame&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">SG</span><span class="o">-&gt;</span><span class="n">LoadSaveGame</span><span class="p">(</span><span class="n">SelectedSaveSlot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果遇到一些额外情况需要处理，实现接口的函数或者写在Actor里BeginPlay里都是可选项</p>
<p>另外就是注意到这里： <code>	FString SelectedSaveSlot = UGameplayStatics::ParseOption(Options, &quot;SaveGame&quot;);</code> ，从ini选项配置中读取特定SlotName，这个东西想来想去还是打算在用户配置相关内容里详述（加入有生之年套餐），目前我就先贴上源码吧：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">SSaveGameSettings</span><span class="p">.</span><span class="n">h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#pragma once
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;CoreMinimal.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Engine/DataTable.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;Engine/DeveloperSettings.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;SSaveGameSettings.generated.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UDataTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="n">UCLASS</span><span class="p">(</span><span class="n">Config</span><span class="o">=</span><span class="n">Game</span><span class="p">,</span> <span class="n">defaultconfig</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="n">DisplayName</span><span class="o">=</span><span class="s">&#34;Save Game Settings&#34;</span><span class="p">))</span> <span class="c1">// &#39;defaultconfig&#39; = &#34;Save object config only to Default INIs, never to local INIs.&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">ACTIONROGUELIKE_API</span> <span class="nl">USSaveGameSettings</span> <span class="p">:</span> <span class="k">public</span> <span class="n">UDeveloperSettings</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">GENERATED_BODY</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* Default slot name if UI doesn&#39;t specify any */</span> 
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">EditAnywhere</span><span class="p">,</span> <span class="n">BlueprintReadOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">&#34;General&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">FString</span> <span class="n">SaveSlotName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="cm">/* Soft path must be converted to asset before use */</span>
</span></span><span class="line"><span class="cl">	<span class="n">UPROPERTY</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="n">EditAnywhere</span><span class="p">,</span> <span class="n">BlueprintReadOnly</span><span class="p">,</span> <span class="n">Category</span> <span class="o">=</span> <span class="s">&#34;General&#34;</span><span class="p">,</span> <span class="n">AdvancedDisplay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">TSoftObjectPtr</span><span class="o">&lt;</span><span class="n">UDataTable</span><span class="o">&gt;</span> <span class="n">DummyTablePath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">USSaveGameSettings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">SSaveGameSettings</span><span class="p">.</span><span class="n">cpp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;SSaveGameSettings.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="n">USSaveGameSettings</span><span class="o">::</span><span class="n">USSaveGameSettings</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Default value while nothing is specified in the DefaultGame.ini
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">SaveSlotName</span> <span class="o">=</span> <span class="s">&#34;SaveGame02&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>另外找到的ini文件里：</p>
<pre tabindex="0"><code>[/Script/ActionRoguelike.SSaveGameSettings]
SaveSlotName=SaveSlot04
DummyTablePath=/Game/ActionRoguelike/Monsters/DT_Monsters.DT_Monsters
</code></pre><p>以及在蓝图里OpenLevel里该如何加载特定的SaveGame文件：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/image/ue_parsinggamemodeoptions.png"
        data-srcset="/image/ue_parsinggamemodeoptions.png, /image/ue_parsinggamemodeoptions.png 1.5x, /image/ue_parsinggamemodeoptions.png 2x"
        data-sizes="auto"
        alt="/image/ue_parsinggamemodeoptions.png"
        title="/image/ue_parsinggamemodeoptions.png" /></p>
<h3 id="设计总结">设计总结</h3>
<p>其实总的看下来，大方向上的设计可以说没什么好说的了，得益于Unreal已经帮我们做好的USaveGame和Subsystem，基本上对于框架考虑的负担已经很小了，而有足够的理由时，也可以做出一些变化，比如本例中对于PlayerState的处理。</p>
<p>UML就先不画了，暂且文字总结一下：</p>
<ul>
<li>USSaveGameSubsystem：继承自UGameInstanceSubsystem，拥有和GameInstance一样的生命周期
<ul>
<li>拥有#属性： <code>FString CurrentSlotName</code> 和 <code>USSaveGame CurrentSaveGame</code> ，+单参数动态多播委托： <code>OnSaveGameLoaded</code> 和 <code>OnSaveGameWritten</code></li>
<li>拥有+方法： <code>void HandleStartingNewPlayer(AController*)</code> 、 <code>bool OverrideSpawnTransform(AController*)</code> 、 <code>void SetSlotName(FString)</code> 、 <code>void WriteSaveGame()</code> 、 <code>LoadSaveGame(FString)</code> 和+重载的方法： <code>Initialize(FSubsystemCollectionBase&amp;)</code></li>
<li>其中，<code>WriteSaveGame</code> 负责Actors和PlayerState的保存逻辑，可以在任何想要保存的地方调用，这个方法内部调用了PlayerState里的 <code>SavePlayerState</code></li>
<li><code>LoadSaveGame</code> 负责Actors的加载逻辑，在GameMode里的 <code>Init</code> 里调用，确保在Actor的BeginPlay调用之前进行读取</li>
<li><code>HandleStartingNewPlayer</code> 、 <code>OverrideSpawnTransform</code> 负责PlayerState的加载逻辑，在GameMode里重载的 <code>HandleStartingNewPlayer</code> 中调用</li>
<li>在GameMode里重载的 <code>HandleStartingNewPlayer</code> 中， <code>HandleStartingNewPlayer</code> 调用了PlayerState里的 <code>LoadPlayerState</code>，且在 <code>Super::HandleStartingNewPlayer</code> 之前，确保UI加载前已经完成读取，<code>OverrideSpawnTransform</code> 则是用于还原Pawn的位置信息</li>
</ul>
</li>
<li>USSaveGame：继承自USaveGame，基本上是一个数据类
<ul>
<li>拥有+属性 <code>TArray&lt;FPlayerSaveData&gt; SavedPlayers</code> （声明为数组的好处是方便进行多人游戏的扩展）和 <code>TArray&lt;FActorSaveData&gt; SavedActors</code></li>
<li>在 <code>FActorSaveData</code> 结构体中使用了 <code>TArray&lt;uint8&gt; ByteData</code> 以进行序列化保存Actor的变量</li>
<li>拥有+方法： <code>FPlayerSaveData* GetPlayerData(APlayerState*)</code> 来获取正确的Player的PlayerData，在Load PlayerState的流程中调用</li>
</ul>
</li>
<li>PlayerState：拥有两个针对PlayerState进行保存和加载的方法</li>
<li>ISGameplayInterface：提供用于标记需要保存的Actor的接口，拥有方法 <code>void OnActorLoaded()</code></li>
</ul>
<p>可以看出，大体上两个类一个负责管理一个负责数据，依赖了PlayerState进行中转，管理类中的数据类实例不进行公开，是一个很标准的SaveGame设计，当然也有一些思考的地方，主要集中在对PlayerState的处理上，我在这里就先不说想法了，毕竟设计嘛，总归是先模仿了，后续慢慢加入自己的想法不断改进，我的水平既然还在模仿的地方，那就不必献丑了</p>
<h3 id="一些补充和提高篇的展望">一些补充和提高篇的展望</h3>
<p>事实上，这套保存系统并不算复杂，对于一些中大型项目，这个确实可以作为一个保存系统设计的起点，那么对于这套保存系统，还需要一些什么东西呢？</p>
<p>首先，很明显地以现在组件化开发的模式，光保存Actor是不够的，还有各种ActorComponent需要保存，甚至也不知道以后虚幻会不会大张旗鼓地全面使用ECS模式，那整个实现又不一样了。</p>
<p>其次是对于Destroyed的Actor，通过这样的方法是保存不到的。当然想实现也行，不过我现在的考虑可能还不够成熟，就不展开说了（第一步是用参考 <code>PlayerSaveData</code> 里使用成员变量 <code>bResumeAtTransform</code> 做标记的方法，然后hmmmmmmmmmm，balabala，最后加载时调用一下Destroy，就可以了）</p>
<p>除此之外，虚幻4示例项目ActionRPG的URPGSaveGame立重载了USaveGame的Serialize()，使得支持不同版本的存档，对于有更新需求的游戏来说，是个不错的参考。</p>
<p>另外，如果实现联机，有关获取PlayerState的问题的参考如下：</p>
<blockquote>
<p>客户端获取Actor PlayerController的途径有Server SetOwner-&gt;Client GetOwner，但不唯一。通过在Server记录PlayerController准确的Index然后传给Client，让Client使用GetPlayerController（Index）能获取到正确的PlayerController；使用PlayerState，GetPlayerStatus-&gt;GetPlayerID-&gt;GetPlayerControllerFromID亦可得到正确的PlayerController。</p>
</blockquote>
<p>From：<a href="https://www.bilibili.com/read/cv12535946" target="_blank" rel="noopener noreffer ">UE4笔记8：多人情况下获取玩家控制器的问题</a></p>
<p>最后，对于额外的关卡流保存和加载，可以参考 <a href="https://github.com/sinbad/SPUD" target="_blank" rel="noopener noreffer ">Steve&rsquo;s Library</a>（很强）</p>
<p>理论上，这些应该都会加入提高篇，而提高篇则会加入有生之年套餐！</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-11-09</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" data-title="【个人探索】研究一下保存游戏的设计与实现细节（基础篇）" data-hashtags="Unreal,个人探索,保存游戏,开发设计,序列化,项目源码解读,内含有生之年,基础"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" data-hashtag="Unreal"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" data-title="【个人探索】研究一下保存游戏的设计与实现细节（基础篇）"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" data-title="【个人探索】研究一下保存游戏的设计与实现细节（基础篇）"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="/posts/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2%E7%A0%94%E7%A9%B6%E4%B8%80%E4%B8%8B%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/" data-title="【个人探索】研究一下保存游戏的设计与实现细节（基础篇）"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/unreal/">Unreal</a>,&nbsp;<a href="/tags/%E4%B8%AA%E4%BA%BA%E6%8E%A2%E7%B4%A2/">个人探索</a>,&nbsp;<a href="/tags/%E4%BF%9D%E5%AD%98%E6%B8%B8%E6%88%8F/">保存游戏</a>,&nbsp;<a href="/tags/%E5%BC%80%E5%8F%91%E8%AE%BE%E8%AE%A1/">开发设计</a>,&nbsp;<a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/">序列化</a>,&nbsp;<a href="/tags/%E9%A1%B9%E7%9B%AE%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">项目源码解读</a>,&nbsp;<a href="/tags/%E5%86%85%E5%90%AB%E6%9C%89%E7%94%9F%E4%B9%8B%E5%B9%B4/">内含有生之年</a>,&nbsp;<a href="/tags/%E5%9F%BA%E7%A1%80/">基础</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0%E5%A4%A7%E9%92%8A-%E8%99%9A%E5%B9%BBcpp%E7%9A%84%E8%BF%9B%E9%98%B6%E4%B9%8B%E8%B7%AF/" class="prev" rel="prev" title="【课堂笔记】大钊-虚幻Cpp的进阶之路"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>【课堂笔记】大钊-虚幻Cpp的进阶之路</a>
            <a href="/posts/%E6%9D%82%E8%B0%88%E7%B3%BB%E5%88%97%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E4%B9%88%E8%8F%9C/" class="next" rel="next" title="【杂谈系列】我为什么这么菜？？？">【杂谈系列】我为什么这么菜？？？<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.105.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">NightDogC</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"search":{"algoliaAppID":"KJIM11MKHB","algoliaIndex":"Blog","algoliaSearchKey":"3b26d56f84469fd1c614a710d39a0419","highlightTag":"em","maxResultLength":15,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js"></script><script type="text/javascript" src="/js/custom.js"></script></body>
</html>
